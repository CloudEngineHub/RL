import argparse
import pickle

import matplotlib.pyplot as plt
import torch
from transformers import AutoTokenizer
from vllm import LLM, SamplingParams

"""
uv run --env-file .env --extra vllm --with matplotlib tools/model_diagnostics/2-vllm-generate-shard-clean.py
"""


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument("--model_dir", type=str, default="nvidia/Nemotron-H-8B-Base-8K")
    parser.add_argument(
        "--pickle_shard_path",
        type=str,
        default="vllm_dbg_nm5/vllm_generate_inputs_768:1024.pkl",
    )
    parser.add_argument("--local_index", type=int, default=229)
    parser.add_argument(
        "--max_length", type=int, default=4096, help="max model length and max tokens"
    )
    parser.add_argument("--tp_size", type=int, default=1)
    return parser.parse_args()


def extract_logprobs(logprobs):
    output = []
    for lp in logprobs:
        if lp is not None:
            output.append(list(lp.values())[0].logprob)
    return output


def main():
    args = parse_args()

    model_dir = args.model_dir
    tp_size = args.tp_size
    pickle_shard_path = args.pickle_shard_path
    with open(pickle_shard_path, "rb") as f:
        data = pickle.load(f)
    tokenizer = AutoTokenizer.from_pretrained(model_dir)
    # Behavior in Nemo RL
    if tokenizer.pad_token is None:
        tokenizer.pad_token = tokenizer.eos_token

    # NOTE: only needed the section underneath this to figure out global index to local, but the logic doesn't seem right. order may not be preserved
    local_index = args.local_index
    ###### Match digits separated by a colon before .pkl
    #####match = re.search(r"_(\d+):(\d+)\.pkl$", pickle_shard_path)
    #####if match:
    #####    start_idx, end_idx= int(match.group(1)), int(match.group(2))

    #####assert start_idx <= args.index < end_idx, f"Index {args.index} is not in the range [{start_idx}, {end_idx})"

    #####local_index = args.index - start_idx

    ################## START
    ref_tokens = [
        1,
        10,
        6775,
        1267,
        11,
        4019,
        1010,
        99565,
        5966,
        26630,
        42738,
        1317,
        15047,
        1278,
        3629,
        4127,
        1046,
        27039,
        2143,
        4832,
        6625,
        1307,
        3603,
        4873,
        1286,
        30620,
        19762,
        1046,
        1877,
        1784,
        4556,
        1307,
        1278,
        43267,
        1307,
        2295,
        22487,
        13509,
        38801,
        1395,
        1032,
        1049,
        1052,
        1054,
        1046,
        20776,
        1278,
        3935,
        1307,
        1278,
        2295,
        38801,
        1338,
        12598,
        1681,
        3648,
        5966,
        26630,
        42738,
        1010,
        11,
        102897,
        1010,
        57651,
        1454,
        38801,
        1010,
        1975,
        2149,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        21366,
        106151,
        1335,
        5430,
        1502,
        41086,
        7489,
        1080,
        68053,
        49310,
        26524,
        65896,
        56491,
        1785,
        14384,
        26439,
        43881,
        39833,
        13453,
        25537,
        1436,
        124078,
        3461,
        49198,
        1067,
        1906,
        1226,
        1140,
        1168,
        6451,
        6554,
        55253,
        4901,
        1184,
        54566,
        1184,
        12513,
        94668,
        77355,
        1327,
        1046,
        94394,
        3256,
        1116,
        49512,
        62222,
        124836,
        36575,
        1036,
        2195,
        7355,
        1174,
        7515,
        6283,
        15690,
        3163,
        88188,
        1225,
        1139,
        1168,
        2326,
        5933,
        1429,
        1622,
        12237,
        104634,
        12737,
        1080,
        76790,
        19648,
        92133,
        2581,
        32937,
        35459,
        1040,
        4699,
        50281,
        18951,
        18807,
        56330,
        72433,
        6788,
        63575,
        75972,
        31326,
        37619,
        65139,
        97083,
        93233,
        12887,
        91624,
        17368,
        1159,
        32227,
        96106,
        1815,
        31940,
        14499,
        112610,
        11749,
        34795,
        10425,
        18028,
        31216,
        10673,
        69439,
        37504,
        13686,
        19813,
        7820,
        46168,
        120618,
        106497,
        29246,
        1137,
        54448,
        92275,
        3253,
        1366,
        37914,
        23403,
        32227,
        31479,
        16466,
        1045,
        1116,
        1774,
        80422,
        1089,
        101191,
        42120,
        61690,
        10101,
        72570,
        98735,
        1295,
        85768,
        12979,
        61573,
        2011,
        2161,
        3720,
        57884,
        2371,
        1282,
        1763,
        1115,
        92243,
        4726,
        16971,
        1044,
        19540,
        31421,
        57101,
        5162,
        2954,
        1040,
        2521,
        1497,
        13503,
        31182,
        1137,
        1256,
        17152,
        5476,
        5162,
        12133,
        1226,
        1157,
        1156,
        29878,
        3134,
        47989,
        3905,
        9774,
        101956,
        110169,
        4610,
        1428,
        1240,
        1159,
        1145,
        1154,
        71409,
        4305,
        12584,
        1608,
        11098,
        1697,
        1123,
        2149,
        5359,
        6711,
        80338,
        4512,
        102404,
        3390,
        8541,
        35489,
        60453,
        1302,
        120764,
        3979,
        12694,
        5596,
        1152,
        51897,
        1871,
        2320,
        60806,
        81228,
        32189,
        90693,
        18965,
        3441,
        12250,
        1047,
        1417,
        46710,
        3373,
        74700,
        98674,
        27371,
        1137,
        39417,
        4026,
        3262,
        94728,
        80181,
        1936,
        1642,
        1419,
        9992,
        1371,
        54566,
        1143,
        76491,
        74628,
        16016,
        17118,
        42964,
        23959,
        119401,
        1046,
        68443,
        1240,
        1157,
        1152,
        1148,
        65297,
        1095,
        71574,
        114643,
        16051,
        84193,
        1532,
        101475,
        107553,
        108334,
        8334,
        8252,
        1082,
        2130,
        6979,
        51472,
        38347,
        34052,
        87227,
        6562,
        1138,
        6828,
        103807,
        36770,
        70527,
        1137,
        9001,
        1143,
        58231,
        60780,
        25967,
        19973,
        56340,
        32351,
        76986,
        16055,
        1239,
        1186,
        1162,
        19927,
        16273,
        58051,
        6669,
        75535,
        42837,
        1290,
        1907,
        93072,
        128352,
        1545,
        111370,
        77741,
        31377,
        1377,
        3717,
        1175,
        1424,
        16705,
        86614,
        2432,
        1443,
        2280,
        41664,
        76089,
        8131,
        1144,
        30606,
        1103,
        1815,
        2493,
        1121,
        12408,
        100076,
        51183,
        82501,
        13840,
        5908,
        12594,
        1569,
        2558,
        17227,
        1173,
        17437,
        105718,
        1013,
        1010,
        26377,
        10212,
        1041,
        25510,
        111385,
        108862,
        25012,
        19958,
        1133,
        106342,
        37740,
        20543,
        24448,
        8336,
        104927,
        2553,
        4680,
        7732,
        42893,
        20759,
        1452,
        5585,
        11737,
        47083,
        3105,
        3163,
        44498,
        125158,
        118753,
        1388,
        4905,
        13001,
        20477,
        1160,
        1044,
        3509,
        9277,
        19528,
        1173,
        58990,
        1045,
        1885,
        108358,
        4456,
        81582,
        40883,
        48110,
        1118,
        3749,
        12001,
        2159,
        1099,
        1827,
        11142,
        34852,
        62224,
        6617,
        1167,
        21817,
        28414,
        9419,
        10807,
        12906,
        26101,
        14944,
        22942,
        5303,
        1075,
        6673,
        6673,
        1328,
        2291,
        1009,
        25184,
        1232,
        24901,
        16450,
        1289,
        3125,
        14729,
        119016,
        52510,
        1086,
        1297,
        1332,
        31147,
        29308,
        10417,
        4969,
        20873,
        4982,
        18237,
        118954,
        83965,
        38124,
        113411,
        3408,
        6141,
        55550,
        53548,
        19170,
        2600,
        25251,
        1109,
        88570,
        3406,
        1685,
        27612,
        1095,
        7052,
        7719,
        24314,
        3922,
        22942,
        11931,
        34837,
        1159,
        33081,
        12081,
        40647,
        94098,
        1359,
        29010,
        24803,
        6673,
        3039,
        15061,
        20035,
        1240,
        1157,
        1148,
        1150,
        37402,
        1072,
        14332,
        48611,
        33703,
        4778,
        17230,
        1099,
        18042,
        3154,
        2130,
        85944,
        1240,
        1159,
        1154,
        1166,
        33670,
        1155,
        2170,
        65093,
        1121,
        79558,
        1095,
        38093,
        8646,
        1647,
        89709,
        62218,
        5242,
        6911,
        1790,
        63132,
        1186,
        3977,
        12289,
        105847,
        12809,
        57271,
        12809,
        3704,
        36723,
        3825,
        15348,
        95346,
        66225,
        22221,
        1166,
        18293,
        1257,
        1110,
        1239,
        1175,
        1187,
        53444,
        35593,
        1115,
        13674,
        42732,
        1466,
        110349,
        2187,
        32136,
        75858,
        36063,
        23224,
        15500,
        10146,
        1188,
        16007,
        60288,
        11790,
        14595,
        1264,
        12684,
        1150,
        110621,
        17766,
        5536,
        9786,
        97191,
        6425,
        22499,
        1295,
        3506,
        39622,
        37914,
        10437,
        1175,
        66122,
        27157,
        85318,
        63968,
        11268,
        52010,
        21681,
        66122,
        3787,
        25062,
        1765,
        17251,
        1476,
        25967,
        4739,
        57488,
        1036,
        5477,
        1077,
        1346,
        1092,
        2580,
        2788,
        99473,
        1127,
        111545,
        105654,
        15189,
        1481,
        8651,
        3726,
        119018,
        24271,
        112046,
        53211,
        3778,
        26658,
        37091,
        5707,
        1177,
        51025,
        1262,
        7533,
        17534,
        48899,
        2544,
        38856,
        1240,
        1159,
        1140,
        1134,
        1227,
        1139,
        1165,
        5149,
        56993,
        20929,
        1073,
        3932,
        1068,
        81012,
        32315,
        12583,
        24777,
        118454,
        1576,
        1061,
        2194,
        10261,
        21698,
        53415,
        49235,
        1129,
        7130,
        1153,
        108277,
        21253,
        25855,
        38980,
        125158,
        1220,
        1156,
        8094,
        54275,
        20064,
        1133,
        22436,
        17644,
        85121,
        19571,
        4549,
        1446,
        8444,
        107626,
        6358,
        3662,
        1009,
        62278,
        62018,
        14985,
        1484,
        1099,
        12574,
        65695,
        42705,
        1216,
        1160,
        35376,
        1188,
        1091,
        20298,
        126442,
        13469,
        7916,
        8402,
        42209,
        105101,
        38813,
        3413,
        20495,
        3906,
        5964,
        1148,
        3999,
        6669,
        26729,
        1938,
        49617,
        4393,
        5368,
        11039,
        1488,
        2918,
        2683,
        10975,
        4211,
        1165,
        67424,
        1093,
        2580,
        6392,
        2845,
        38546,
        1040,
        4699,
        108989,
        62218,
        9100,
        93635,
        12328,
        1279,
        1239,
        1166,
        1143,
        118887,
        22927,
        28247,
        16855,
        100419,
        70914,
        55670,
        125279,
        12415,
        10476,
        2908,
        1790,
        35042,
        129297,
        5286,
        40623,
        16660,
        27886,
        77501,
        22609,
        1913,
        21518,
        1226,
        1155,
        1186,
        116942,
        45396,
        5114,
        51130,
        25554,
        7360,
        1291,
        1501,
        37200,
        16327,
        1538,
        1535,
        2154,
        5773,
        1010,
        30768,
        1047,
        1417,
        6347,
        4507,
        38114,
        2544,
        3721,
        128937,
        1073,
        7985,
        45605,
        23295,
        1140,
        48580,
        17863,
        12443,
        110200,
        12596,
        1045,
        12198,
        4195,
        6800,
        13571,
        66792,
        19561,
        54618,
        32040,
        7247,
        16568,
        43460,
        21479,
        55665,
        1373,
        4228,
        27278,
        1225,
        1180,
        1181,
        2107,
        4427,
        22226,
        8285,
        9109,
        1046,
        17511,
        50311,
        110937,
        27568,
        43784,
        120831,
        1095,
        21521,
        118290,
        57844,
        9652,
        1133,
        55605,
        1353,
        23210,
        1424,
        1771,
        6585,
        24396,
        59081,
        90070,
        95510,
        3589,
        1285,
        10052,
        21865,
        1767,
        43933,
        47424,
        12570,
        1047,
        10311,
        1263,
        54452,
        29532,
        1186,
        18092,
        20809,
        15813,
        3273,
        1273,
        18357,
        100152,
        52445,
        119061,
        10691,
        1119,
        17576,
        4462,
        10149,
        13287,
        3455,
        32492,
        3163,
        10684,
        2713,
        5596,
        1152,
        76057,
        1091,
        3176,
        117719,
        1259,
        42391,
        76790,
        19648,
        90646,
        1778,
        4035,
        86473,
        53178,
        27771,
        75501,
        6293,
        1175,
        38740,
        43911,
        14671,
        5180,
        1046,
        14244,
        19359,
        1965,
        1097,
        3922,
        4897,
        1095,
        78107,
        35981,
        30244,
        1175,
        128841,
        2713,
        56330,
        11121,
        1159,
        24274,
        31784,
        35151,
        116240,
        66122,
        8443,
        15902,
        23634,
        1013,
        1010,
        1896,
        1359,
        36457,
        4009,
        70258,
        49566,
        45009,
        42893,
        11795,
        34245,
        34794,
        10106,
        23327,
        5323,
        8386,
        3376,
        30547,
        3134,
        1356,
        71332,
        56977,
        117957,
        3308,
        3824,
        13896,
        1115,
        80453,
        40803,
        1503,
        1541,
        25354,
        1115,
        56590,
        104643,
        1130,
        68275,
        57434,
        22883,
        30278,
        15185,
        67123,
        1240,
        1159,
        1146,
        1133,
        35574,
        12799,
        1973,
        25855,
        5538,
        1138,
        40309,
        1297,
        97179,
        31794,
        26549,
        2366,
        1187,
        31653,
        1175,
        20353,
        5503,
        9446,
        13947,
        9787,
        23743,
        8535,
        45384,
        19106,
        1790,
        2025,
        27907,
        3979,
        12694,
        32442,
        1510,
        4410,
        27312,
        61488,
        4118,
        6201,
        45257,
        1086,
        7379,
        66122,
        7130,
        1186,
        1060,
        25413,
        52500,
        6149,
        129313,
        2531,
        100845,
        4541,
        6100,
        8247,
        81849,
        36678,
        20848,
        89560,
        6562,
        1182,
        6016,
        4285,
        3495,
        89447,
        18448,
        71197,
        7746,
        1168,
        115767,
        24098,
        12273,
        1151,
        81218,
        4445,
        49395,
        8682,
        1226,
        1134,
        1150,
        1046,
        19489,
        119821,
        29362,
        2794,
        9725,
        1279,
        1239,
        1165,
        1173,
        16509,
        3823,
        33512,
        6126,
        7128,
        67937,
        1044,
        4082,
        44260,
        35745,
        4673,
        39197,
        1587,
        4579,
        1391,
        92517,
        32004,
        22075,
        4673,
        6564,
        2713,
        21796,
        26827,
        18021,
        18877,
        5850,
        3591,
        19509,
        104233,
        2243,
        103548,
        10807,
        3097,
        7415,
        31622,
        52700,
        46437,
        10843,
        94706,
        126714,
        35424,
        1136,
        57589,
        10146,
        1190,
        1763,
        1115,
        3609,
        1081,
        1382,
        5685,
        110442,
        2053,
        1264,
        23862,
        1560,
        42749,
        110200,
        1046,
        109326,
        24122,
        2389,
        1149,
        25120,
        53487,
        19308,
        8108,
        1264,
        40522,
        46130,
        17096,
        15986,
        66122,
        31080,
        30004,
        1226,
        1134,
        1153,
        1095,
        9910,
        118535,
        70181,
        19059,
        6851,
        1118,
        2932,
        62180,
        66122,
        10263,
        14894,
        20167,
        9902,
        120339,
        27371,
        1157,
        1269,
        3994,
        1240,
        1159,
        1144,
        1189,
        9367,
        1372,
        1948,
        1611,
        1067,
        5193,
        1353,
        36043,
        75211,
        10212,
        1041,
        7568,
        1159,
        108637,
        3405,
        15357,
        103958,
        5873,
        13623,
        4598,
        22805,
        105047,
        118283,
        41660,
        71936,
        5520,
        1780,
        128368,
        28605,
        67424,
        1239,
        1173,
        1142,
        66122,
        80248,
        1061,
        12223,
        58751,
        1291,
        13633,
        1285,
        3050,
        3723,
        2326,
        16572,
        2114,
        7903,
        1226,
        9025,
        1479,
        11926,
        23743,
        8760,
        36423,
        15422,
        1129,
        3087,
        4901,
        1139,
        3203,
        65191,
        6788,
        61382,
        86123,
        29628,
        15561,
        53261,
        46660,
        67629,
        15774,
        38080,
        1377,
        1046,
        4865,
        76257,
        5226,
        3533,
        60697,
        22006,
        52177,
        66073,
        1047,
        5323,
        3445,
        2868,
        1399,
        4766,
        1443,
        10667,
        1120,
        6035,
        11148,
        3721,
        67056,
        1062,
        13458,
        11117,
        7763,
        2266,
        106637,
        11951,
        1173,
        6799,
        1230,
        13825,
        23238,
        14939,
        108384,
        70717,
        16192,
        19397,
        1095,
        1083,
        5010,
        23645,
        1046,
        29793,
        3191,
        1297,
        37301,
        109090,
        10864,
        8707,
        39020,
        8932,
        82278,
        95417,
        7068,
        1131,
        37239,
        2460,
        19582,
        17214,
        3172,
        1139,
        2220,
        7652,
        99863,
        39385,
        66493,
        24039,
        11350,
        9798,
        16852,
        1913,
        1097,
        58359,
        14396,
        12013,
        2600,
        1084,
        29962,
        85671,
        10875,
        22883,
        15690,
        47424,
        1875,
        5013,
        4498,
        5801,
        84339,
        51627,
        2093,
        1275,
        11895,
        27101,
        1156,
        21803,
        69340,
        55262,
        94822,
        14373,
        13594,
        8682,
        38993,
        1040,
        27978,
        75203,
        42587,
        36290,
        2090,
        1191,
        16228,
        1424,
        3862,
        32312,
        3050,
        30595,
        26985,
        1142,
        2228,
        19881,
        1258,
        83514,
        46005,
        3100,
        6952,
        37210,
        31306,
        42099,
        98312,
        108637,
        31185,
        2461,
        69358,
        5552,
        1101,
        22132,
        1638,
        3990,
        1138,
        1123,
        7290,
        1095,
        3174,
        66438,
        3437,
        1157,
        9855,
        6222,
        35087,
        16835,
        18627,
        4416,
        1689,
        9583,
        2393,
        91344,
        117538,
        13962,
        73742,
        58902,
        1036,
        2938,
        4564,
        1038,
        1080,
        1327,
        8170,
        25688,
        1169,
        27565,
        7237,
        4374,
        2905,
        10206,
        3678,
        6565,
        42611,
        55598,
        11030,
        2021,
        1724,
        2268,
        110812,
        41946,
        10388,
        4778,
        30215,
        48355,
        1407,
        4606,
        6755,
        43995,
        40069,
        12273,
        1135,
        1335,
        23883,
        1895,
        31469,
        1286,
        1911,
        14573,
        1059,
        1013,
        1010,
        1042,
        21751,
        60138,
        35723,
        3914,
        2729,
        24173,
        64441,
        7840,
        1095,
        5707,
        1134,
        6995,
        4275,
        6222,
        10168,
        1275,
        1046,
        65285,
        21369,
        8862,
        4873,
        21637,
        85797,
        82279,
        10713,
        114056,
        75378,
        17936,
        1103,
        48314,
        53003,
        5927,
        33050,
        104964,
        2699,
        1485,
        6519,
        45955,
        1040,
        27304,
        7620,
        13163,
        30111,
        9488,
        3662,
        80488,
        5047,
        10758,
        1305,
        2996,
        1269,
        1938,
        1676,
        1095,
        44637,
        1225,
        1165,
        1148,
        1333,
        15692,
        1046,
        46266,
        81668,
        80807,
        101165,
        2236,
        8693,
        36348,
        19152,
        1364,
        10368,
        3677,
        32301,
        11045,
        13596,
        9788,
        1240,
        1159,
        1154,
        1171,
        7619,
        7619,
        118177,
        72124,
        2202,
        1272,
        1107,
        24895,
        17304,
        1046,
        20205,
        7661,
        1061,
        44255,
        11429,
        11449,
        1071,
        4456,
        21035,
        130709,
        1118,
        1586,
        66224,
        1506,
        3577,
        11626,
        3848,
        1714,
        8411,
        2641,
        1199,
        1158,
        19540,
        3688,
        63202,
        1047,
        5323,
        2857,
        43058,
        10700,
        6757,
        114766,
        5280,
        11900,
        27226,
        9018,
        129335,
        12588,
        2416,
        1225,
        1133,
        1170,
        33102,
        23003,
        6461,
        16179,
        3922,
        1359,
        64537,
        1068,
        1047,
        12840,
        80935,
        5618,
        1079,
        17310,
        4358,
        1277,
        72319,
        4836,
        117801,
        1091,
        6154,
        2236,
        22970,
        28162,
        25592,
        25719,
        1356,
        102043,
        1927,
        1373,
        15373,
        59378,
        85084,
        90377,
        1117,
        19648,
        36967,
        1085,
        15749,
        66122,
        120237,
        15690,
        1855,
        97826,
        21349,
        17117,
        3163,
        61262,
        1335,
        32139,
        15355,
        48611,
        102467,
        1169,
        54594,
        8390,
        112718,
        120977,
        24609,
        16349,
        57355,
        19986,
        15800,
        65429,
        1197,
        1133,
        24579,
        16834,
        76733,
        87287,
        6511,
        1157,
        49719,
        29776,
        1095,
        99345,
        89417,
        1359,
        86030,
        5280,
        11614,
        9853,
        47466,
        5032,
        27809,
        1356,
        25297,
        43419,
        117184,
        21055,
        37275,
        5295,
        3074,
        17810,
        122322,
        1095,
        5082,
        35693,
        3254,
        121310,
        47465,
        4230,
        122610,
        1526,
        7298,
        40236,
        55452,
        1762,
        1131,
        114100,
        14238,
        3905,
        1073,
        41150,
        61549,
        17118,
        13908,
        101044,
        7713,
        1259,
        1861,
        4475,
        1283,
        1104,
        98714,
        65318,
        83499,
        1009,
        9239,
        1495,
        48632,
        93656,
        2123,
        1153,
        36936,
        1105,
        6325,
        10785,
        64324,
        4236,
        19919,
        1040,
        23840,
        12724,
        1123,
        2149,
        62844,
        67544,
        30946,
        3083,
        2099,
        120944,
        61169,
        13276,
        3791,
        6746,
        38347,
        4272,
        1708,
        60275,
        1171,
        105764,
        3223,
        1240,
        1157,
        1145,
        1185,
        28817,
        12631,
        117957,
        79165,
        31795,
        2383,
        2043,
        4904,
        29757,
        2970,
        2077,
        28812,
        1106,
        1706,
        12030,
        74908,
        50276,
        50892,
        28609,
        22386,
        1157,
        1058,
        8304,
        4026,
        6851,
        12544,
        1210,
        1145,
        24934,
        1191,
        124711,
        23403,
        115469,
        24804,
        1095,
        13841,
        5323,
        15002,
        1040,
        15097,
        126207,
        31830,
        1573,
        1521,
        95127,
        128841,
        18961,
        44798,
        13442,
        5248,
        62577,
        129323,
        15286,
        61871,
        28071,
        1240,
        1159,
        1154,
        1170,
        74601,
        4111,
        3990,
        1190,
        6973,
        1240,
        1159,
        1140,
        1158,
        68711,
        128207,
        10684,
        10684,
        7661,
        1061,
        3539,
        1009,
        129907,
        24670,
        52445,
        63784,
        1040,
        11098,
        115702,
        83172,
        7360,
        7360,
        100225,
        127580,
        1137,
        21104,
        68531,
        6508,
        11710,
        10180,
        80259,
        21365,
        1409,
        1611,
        3914,
        5893,
        108840,
        6892,
        4022,
        106677,
        1095,
        4998,
        90980,
        17429,
        25176,
        81061,
        45900,
        1735,
        66027,
        1188,
        1417,
        1100,
        3903,
        17804,
        17447,
        13440,
        1009,
        3419,
        69649,
        5596,
        1139,
        7197,
        1166,
        3010,
        11135,
        82838,
        6046,
        1165,
        22599,
        1744,
        14963,
        17621,
        58933,
        7290,
        1044,
        2466,
        4541,
        2326,
        65605,
        36160,
        1283,
        8919,
        47150,
        96378,
        11346,
        27738,
        1824,
        57589,
        112974,
        6744,
        3262,
        5795,
        1430,
        34970,
        47260,
        4598,
        4286,
        77176,
        13453,
        11429,
        1875,
        11426,
        1095,
        89462,
        1659,
        1267,
        81871,
        3539,
        1009,
        1913,
        2017,
        50246,
        1226,
        1173,
        1149,
        43498,
        41965,
        123572,
        38388,
        21486,
        10413,
        12302,
        43916,
        1184,
        66586,
        2694,
        1152,
        56361,
        92533,
        1111,
        1353,
        13339,
        1289,
        3125,
        1392,
        2845,
        118432,
        20965,
        1188,
        32070,
        38275,
        1158,
        4738,
        1203,
        1146,
        11305,
        1177,
        11997,
        43853,
        50112,
        12954,
        1010,
        44975,
        1428,
        26247,
        31479,
        76133,
        8867,
        3850,
        5964,
        1137,
        1101,
        1621,
        70007,
        59462,
        9764,
        3087,
        9764,
        1061,
        4417,
        54036,
        1621,
        21259,
        66122,
        1047,
        3607,
        77707,
        5724,
        1099,
        120237,
        15690,
        72808,
        4252,
        1172,
        98755,
        20458,
        81148,
        2204,
        1143,
        19933,
        14640,
        14516,
        53261,
        66122,
        10653,
        1097,
        33984,
        2184,
        2068,
        6046,
        1176,
        3669,
        81465,
        3752,
        85022,
        11000,
        24020,
        4815,
        18275,
        1415,
        13742,
        1524,
        11662,
        4610,
        115886,
        125692,
        1144,
        1225,
        1182,
        1156,
        3605,
        1013,
        1010,
        13734,
        15681,
        8306,
        42705,
        35582,
        59820,
        14827,
        1174,
        50745,
        1288,
        1110,
        13674,
        9505,
        76086,
        55486,
        9590,
        117957,
        8029,
        30494,
        1104,
        6466,
        2141,
        110272,
        1342,
        1134,
        53803,
        7657,
        11400,
        14833,
        100845,
        4700,
        44823,
        1308,
        72858,
        22386,
        1140,
        13618,
        49105,
        1083,
        10142,
        36608,
        16290,
        24098,
        10785,
        18023,
        4226,
        1171,
        1349,
        7150,
        48571,
        29053,
        26535,
        1398,
        1586,
        1331,
        1533,
        1372,
        1662,
        1116,
        1620,
        6907,
        1532,
        13464,
        57355,
        74562,
        5962,
        1675,
        32012,
        1229,
        1181,
        1154,
        2819,
        1152,
        118950,
        1795,
        122305,
        55507,
        1752,
        1310,
        1100,
        5519,
        1150,
        32390,
        13908,
        96279,
        41416,
        2998,
        15969,
        13609,
        1234,
        1166,
        1173,
        26574,
        109716,
        45192,
        25320,
        3321,
        1168,
        1068,
        1087,
        27493,
        6755,
        112095,
        1559,
        3061,
        121340,
        54015,
        28653,
        103080,
        50094,
        129269,
        6970,
        30031,
        20566,
        8313,
        1180,
        4813,
        3848,
        17234,
        13148,
        6173,
        1225,
        1180,
        1151,
        12809,
        110610,
        56007,
        6399,
        22596,
        22980,
        3437,
        1180,
        33280,
        44619,
        1647,
        2923,
        99939,
        60662,
        63515,
        9508,
        55938,
        21465,
        27878,
        98817,
        68020,
        1040,
        18461,
        24173,
        1885,
        3405,
        18961,
        40515,
        41388,
        7065,
        1187,
        2892,
        24876,
        102477,
        16488,
        1608,
        127659,
        15591,
        10694,
        24407,
        1009,
        8379,
        1304,
        2954,
        6350,
        88462,
        9631,
        5114,
        16251,
        90295,
        54322,
        102811,
        1058,
        12377,
        3870,
        1101,
        55675,
        8390,
        5611,
        1174,
        25109,
        15045,
        1009,
        28647,
        18652,
        124116,
        29432,
        7936,
        28030,
        12020,
        39368,
        20387,
        2471,
        1225,
        1132,
        1132,
        73810,
        46958,
        118294,
        6256,
        1157,
        1109,
        6020,
        23496,
        65262,
        129783,
        88564,
        19592,
        42780,
        118840,
        104864,
        15179,
        2,
        33114,
        1058,
        25342,
    ]
    files = [
        "vllm_dbg_nm5/vllm_generate_inputs_0:256.pkl",
        "vllm_dbg_nm5/vllm_generate_inputs_1024:1280.pkl",
        "vllm_dbg_nm5/vllm_generate_inputs_1280:1536.pkl",
        "vllm_dbg_nm5/vllm_generate_inputs_1536:1792.pkl",
        "vllm_dbg_nm5/vllm_generate_inputs_1792:2048.pkl",
        "vllm_dbg_nm5/vllm_generate_inputs_256:512.pkl",
        "vllm_dbg_nm5/vllm_generate_inputs_512:768.pkl",
        "vllm_dbg_nm5/vllm_generate_inputs_768:1024.pkl",
    ]
    for f in files:
        foo = pickle.load(open(f, "rb"))
        foo_ids = foo["input_ids"]
        diffs = [
            sum(foo_ids[i][:40] - torch.tensor(ref_tokens)[:40]).item()
            for i in range(256)
        ]
        print(f"{f} {any(d == 0 for d in diffs)}")
        for ix in range(256):
            if diffs[ix] == 0:
                print(f"{f} {ix=} {local_index=} {ix == local_index=}")
    ################## END

    input_ids = data["input_ids"]
    input_lengths = data["input_lengths"]
    batch_stop_strings: list[list[str]] = data.get("stop_strings", [])

    # stop_strings = self._merge_stop_strings(batch_stop_strings)
    # sampling_params = self._build_sampling_params(
    #    greedy=grey,
    #    stop_strings=stop_strings,
    # )

    sampling_params = SamplingParams(
        temperature=1.0,
        top_p=1.0,
        top_k=-1,
        max_tokens=args.max_length,
        logprobs=0,
        prompt_logprobs=0,
        # stop_token_ids=self.cfg["stop_token_ids"],
        # stop=stop_strings,
        include_stop_str_in_output=True,
    )

    # TODO: match nemo-rl (for single node -- should be equal to 0index of this shard)
    seed = 3

    llm = LLM(
        model=model_dir,
        load_format="auto",
        tensor_parallel_size=tp_size,
        gpu_memory_utilization=0.5,
        enable_prefix_caching=False,
        enable_chunked_prefill=False,
        dtype="bfloat16",  # TODO: plumb this in from nemo-rl
        seed=seed,
        enforce_eager=True,
        max_model_len=args.max_length,
        trust_remote_code=True,
        enable_sleep_mode=True,
        disable_log_stats=True,
    )

    # Convert inputs to vLLM format
    batch_size = input_ids.shape[0]
    # Original input length with padding
    padded_input_length = input_ids.size(1)

    # Prepare prompts for vLLM (removing padding)
    prompts = []

    for i in range(batch_size):
        # Use input_lengths to get only valid tokens (not padding)
        valid_length = input_lengths[i].item()
        valid_ids = (
            input_ids[i, :valid_length] if valid_length > 0 else input_ids[i, :0]
        )
        token_ids = valid_ids.tolist()

        prompts.append({"prompt_token_ids": token_ids})

    outputs = llm.generate(prompts, sampling_params)

    # logprobs = torch.tensor(extract_logprobs(outputs[0].prompt_logprobs))
    logprobs = torch.tensor(extract_logprobs(outputs[local_index].outputs[0].logprobs))

    # fill out the bad sequence
    generated_tokens = outputs[local_index].outputs[0].token_ids

    max_match = float("-inf")
    max_match_i = None
    for i in range(256):
        _prompt = input_ids[i][: input_lengths[i]]
        _response = outputs[i].outputs[0].token_ids
        _full = torch.cat([_prompt, torch.tensor(_response)])

        match = 0
        for a, b in zip(_full, ref_tokens):
            a, b = int(a), int(b)
            if a != b:
                break
            match += 1

        print(f"{i=} {match=}")
        if match > max_match:
            max_match = max(max_match, match)
            max_match_i = i
    print(f"{max_match=} {max_match_i=} {seed}")

    ####### Calculate total sequence length (original input length + generated tokens)
    ######total_length = padded_input_length + args.max_length
    ######full_output = torch.full(
    ######    (total_length,), tokenizer.pad_token_id, dtype=input_ids.dtype
    ######)
    ###### # Copy original input (with padding) into the beginning
    ######full_output[:padded_input_length] = input_ids[local_index][:padded_input_length]

    ####### Add generated tokens after the original input
    ######full_output[padded_input_length : padded_input_length + len(generated_tokens)] = (
    ######    torch.tensor(generated_tokens)
    ######)

    full_output = torch.cat(
        [
            input_ids[local_index][: input_lengths[local_index]],
            torch.tensor(generated_tokens),
        ]
    )
    outputs_two_pass = llm.generate(
        {"prompt_token_ids": full_output.tolist()}, sampling_params
    )
    logprobs_two_pass = torch.tensor(
        extract_logprobs(outputs_two_pass[0].prompt_logprobs)
    )

    # align the two
    A = logprobs
    B = logprobs_two_pass[input_lengths[local_index] - 1 :]

    abs_diff = torch.abs(A - B)
    new_error = torch.exp(abs_diff).sum() / len(abs_diff)
    x_axis = torch.arange(len(abs_diff)) + input_lengths[local_index]

    max_abs_error_idx = torch.argmax(abs_diff).item()
    max_abs_error = abs_diff[max_abs_error_idx].item()

    plt.plot(x_axis, A, label="A")
    plt.plot(x_axis, B, label="B")
    plt.plot(x_axis, abs_diff, label="abs(A - B)")
    plt.plot(
        x_axis[max_abs_error_idx],
        abs_diff[max_abs_error_idx],
        "ro",
        markersize=8,
        label=f"Max abs error: {max_abs_error:.4f} (idx: {max_abs_error_idx})",
    )
    plt.xlabel("Token Position (starting from prompt end)")
    plt.ylabel("Log Probability/Difference")
    plt.title(f"New LogProb Error: {new_error:.4f}")
    plt.legend()
    plt.tight_layout()
    plt.savefig("terry_vllm.png")
    print("ALL DONE")

    breakpoint()
    print()


if __name__ == "__main__":
    main()
